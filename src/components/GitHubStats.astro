---
interface Props {
  username?: string;
}

const { username = "doguyilmaz" } = Astro.props;
---

<section class="space-y-6">
  <div class="text-center">
    <h2 class="text-3xl font-bold mb-4">GitHub Activity</h2>
    <p class="text-primary-300 max-w-2xl mx-auto">
      Open source contributions and recent activity on GitHub
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- GitHub Stats Card -->
    <div class="bg-lightercontentbackground border border-primary-600 rounded-xl p-6">
      <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        GitHub Statistics
      </h3>
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <span class="text-primary-300">Public Repos</span>
          <span class="font-semibold" id="public-repos">--</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-primary-300">Followers</span>
          <span class="font-semibold" id="followers">--</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-primary-300">Following</span>
          <span class="font-semibold" id="following">--</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-primary-300">Member Since</span>
          <span class="font-semibold" id="member-since">--</span>
        </div>
      </div>
      <div class="mt-6">
        <a 
          href={`https://github.com/${username}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 text-primary-400 hover:text-primary-300 transition-colors"
        >
          View GitHub Profile
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
      </div>
    </div>

    <!-- Contribution Graph -->
    <div class="bg-lightercontentbackground border border-primary-600 rounded-xl p-6">
      <h3 class="text-xl font-semibold mb-4">Contribution Activity</h3>
      <div class="relative">
        <img 
          src={`https://ghchart.rshah.org/5865f2/${username}`}
          alt="GitHub Contributions"
          class="w-full rounded filter brightness-90"
        />
      </div>
      <div class="mt-4 flex items-center gap-4 text-sm">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-gray-700 rounded"></div>
          <span class="text-primary-400">Less</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-green-600 rounded"></div>
          <span class="text-primary-400">More</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="bg-lightercontentbackground border border-primary-600 rounded-xl p-6">
    <h3 class="text-xl font-semibold mb-4">Recent Activity</h3>
    <div id="recent-activity" class="space-y-3">
      <div class="animate-pulse">
        <div class="h-4 bg-primary-700 rounded w-3/4 mb-2"></div>
        <div class="h-4 bg-primary-700 rounded w-1/2"></div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ username }}>
  // Fetch GitHub user data
  fetch(`https://api.github.com/users/${username}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('public-repos').textContent = data.public_repos || '0';
      document.getElementById('followers').textContent = data.followers || '0';
      document.getElementById('following').textContent = data.following || '0';
      
      const createdDate = new Date(data.created_at);
      document.getElementById('member-since').textContent = createdDate.toLocaleDateString('en-US', {
        month: 'short',
        year: 'numeric'
      });
    })
    .catch(err => {
      console.error('Failed to fetch GitHub data:', err);
    });

  // Fetch recent events
  fetch(`https://api.github.com/users/${username}/events/public`)
    .then(res => res.json())
    .then(events => {
      const activityContainer = document.getElementById('recent-activity');
      activityContainer.innerHTML = '';
      
      const recentEvents = events.slice(0, 5);
      
      if (recentEvents.length === 0) {
        activityContainer.innerHTML = '<p class="text-primary-400">No recent public activity</p>';
        return;
      }
      
      recentEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'flex items-start gap-3 py-2';
        
        let icon = 'üìå';
        let action = '';
        
        switch(event.type) {
          case 'PushEvent':
            icon = '‚¨ÜÔ∏è';
            const commits = event.payload.commits?.length || 0;
            action = `Pushed ${commits} commit${commits !== 1 ? 's' : ''} to ${event.repo.name}`;
            break;
          case 'CreateEvent':
            icon = '‚ú®';
            action = `Created ${event.payload.ref_type} in ${event.repo.name}`;
            break;
          case 'PullRequestEvent':
            icon = 'üîÄ';
            action = `${event.payload.action} pull request in ${event.repo.name}`;
            break;
          case 'IssuesEvent':
            icon = 'üêõ';
            action = `${event.payload.action} issue in ${event.repo.name}`;
            break;
          case 'WatchEvent':
            icon = '‚≠ê';
            action = `Starred ${event.repo.name}`;
            break;
          case 'ForkEvent':
            icon = 'üî±';
            action = `Forked ${event.repo.name}`;
            break;
          default:
            action = `${event.type.replace('Event', '')} in ${event.repo.name}`;
        }
        
        const date = new Date(event.created_at);
        const timeAgo = getTimeAgo(date);
        
        eventDiv.innerHTML = `
          <span class="text-xl">${icon}</span>
          <div class="flex-1">
            <p class="text-primary-200">${action}</p>
            <p class="text-sm text-primary-400">${timeAgo}</p>
          </div>
        `;
        
        activityContainer.appendChild(eventDiv);
      });
    })
    .catch(err => {
      console.error('Failed to fetch GitHub events:', err);
      document.getElementById('recent-activity').innerHTML = 
        '<p class="text-primary-400">Unable to load recent activity</p>';
    });

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + ' years ago';
    
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + ' months ago';
    
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + ' days ago';
    
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + ' hours ago';
    
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + ' minutes ago';
    
    return Math.floor(seconds) + ' seconds ago';
  }
</script>